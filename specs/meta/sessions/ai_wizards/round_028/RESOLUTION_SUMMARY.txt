================================================================================
GAP-HYBRID-001 RESOLUTION SUMMARY
================================================================================

Gap: Hybrid mode (Pathfinder + Semantic) no workflow
Priority: MEDIUM
Status: RESOLVED
Date: 2026-01-13

================================================================================
PROBLEM STATEMENT
================================================================================

Section 3.4 of specs/ai_wizards.md mentions hybrid mode (combining Pathfinder 
and Semantic Path wizards) with a brief example but provides NO actionable 
workflow specification:

- No clear triggers for when to use hybrid mode
- No state machine for workflow progression
- No handoff protocol between the two wizards
- No specification for merging results
- No UI presentation specifications
- No conflict resolution strategy

This left implementers without a roadmap for building the feature.

================================================================================
RESOLUTION PROVIDED
================================================================================

A comprehensive 1071-line specification document (engineer.md) covering:

1. UNDERSTANDING HYBRID MODE
   - Philosophy: Layer 1 (folders/semantic) + Layer 2 (filenames/custom)
   - When to use: Real-world files with dual structure
   - Examples: Mission data, healthcare records, sensor readings

2. HYBRID MODE TRIGGERS (3 Scenarios)
   - Scenario A: User explicitly requests after semantic results
   - Scenario B: Auto-trigger when semantic complete + filename patterns detected
   - Scenario C: Pathfinder cascade from remaining untagged files
   - Decision tree with confidence thresholds

3. WORKFLOW STATE MACHINE
   States: WAITING, PRE_DETECTION, SEMANTIC_RESULTS, HYBRID_OFFERED,
           HYBRID_PROCESSING, HYBRID_RESULTS, HYBRID_EDITING, DRAFT_CREATED
   
   Transitions: Clear paths for all user actions and system responses

4. WIZARD HANDOFF PROTOCOL
   - HybridHandoffContext struct for Semantic→Pathfinder transfer
   - Constraint: Pathfinder only processes filenames, ignores folder path
   - Validation: Ensures no conflicting extractions

5. CONFLICT RESOLUTION STRATEGY
   Type A: Field name collision → Keep semantic (folders more reliable)
   Type B: Field value mismatch → Stop, require user decision
   Type C: YAML vs Python mismatch → Escalate to Python
   
   User-facing dialog for explicit conflict resolution

6. COMBINED OUTPUT FORMATS
   - Merged YAML rule (when both components YAML-expressible)
   - Merged Python extractor (when Pathfinder requires Python)
   - JSON structure with semantic + pathfinder metadata
   - Audit trail tracking field sources

7. UI PRESENTATION
   - Hybrid offer dialog (after semantic results)
   - Processing animation (while Pathfinder extracts)
   - Results display (combined fields with source labels)
   - Conflict resolution dialog (for ambiguous cases)

8. INTEGRATION POINTS
   - TUI state machine integration with Discover mode
   - Database schema extensions (hybrid_mode, semantic_confidence, etc.)
   - CLI commands for hybrid workflow creation

9. REAL-WORLD EXAMPLES
   - Healthcare: HL7 files with direction + date in folders, patient_id + 
     message_type in filename
   - Date conflict: ISO vs YYYYMMDD formats → resolved by keeping semantic
   - Complex filename: Quarter expansion requires Python fallback

10. COMPREHENSIVE TESTING
    - 8 unit test scenarios (auto-trigger, merge, conflicts, etc.)
    - Integration tests with full workflow validation
    - Validation rules for hybrid merge safety

11. ERROR HANDLING
    - Pathfinder produces empty results → revert to semantic-only
    - Field collisions → show conflict dialog
    - Invalid YAML merge → generate Python fallback
    - Low semantic confidence → reject hybrid

12. FUTURE ENHANCEMENTS
    - Three-way hybrid (Semantic + Pathfinder + Content Parser)
    - Interactive field mapping with drag-and-drop
    - Cross-wizard debugging view

13. IMPLEMENTATION ROADMAP
    - 14-item checklist for engineers
    - 7 success criteria for validation
    - Decision rationale for all key choices

================================================================================
KEY TECHNICAL CONTRIBUTIONS
================================================================================

1. HybridHandoffContext Struct
   ├─ semantic_fields: HashMap<String, FieldMapping>
   ├─ semantic_expression: String
   ├─ semantic_confidence: u8 (70-100)
   ├─ filenames: Vec<String>
   ├─ source_id: String
   └─ full_paths: Vec<String>

2. Conflict Detection Algorithm
   - Field name collision detection
   - Field value mismatch detection (with data comparison)
   - Type incompatibility detection (YAML vs Python)
   - Automatic resolution preference (semantic > pathfinder)

3. Merge Algorithm
   ├─ Detect conflicts → User resolution → Merge
   ├─ Escalate to Python if any component requires it
   ├─ Preserve audit trail (source tracking)
   └─ Validate merged rule is expressible

4. State Machine with 9 States
   WAITING → PRE_DETECTION → {SEMANTIC_RESULTS | HYBRID_OFFERED | FALLBACK}
   HYBRID_OFFERED → HYBRID_PROCESSING → HYBRID_RESULTS → DRAFT_CREATED

5. Database Schema Extension
   - hybrid_mode: bool
   - semantic_confidence: u8
   - pathfinder_component: string
   - components_yaml: json
   - conflicts_resolved: json[]
   - merged_from_draft_ids: string[]

================================================================================
VALIDATION CHECKLIST
================================================================================

✓ All three trigger scenarios documented with decision criteria
✓ Complete state machine with all transitions defined
✓ HybridHandoffContext struct specified with all fields
✓ Three conflict types identified with resolution strategies
✓ YAML and Python output formats fully specified
✓ UI mockups provided for all dialogs
✓ Database schema extensions for audit trail
✓ 8 test scenarios covering happy path + edge cases
✓ 3 real-world examples with outcomes
✓ Error handling for 4 failure modes
✓ 14-item implementation checklist
✓ 7 success criteria for verification
✓ Future enhancement roadmap included
✓ Related documentation cross-references

================================================================================
IMPACT & READINESS
================================================================================

This resolution enables:
1. Engineers to implement hybrid mode without guesswork
2. QA to test against clear acceptance criteria
3. Users to understand the feature boundaries and workflows
4. Future developers to extend with three-way hybrid

The specification is production-ready and can be handed to engineering
for implementation without further clarification.

================================================================================
